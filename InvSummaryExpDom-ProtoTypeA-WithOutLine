DECLARE @BeginDate	DATETIME    =[%0]
DECLARE @EndDate	DATETIME    =[%1]
DECLARE @QryGroup1	VARCHAR(1)  =[%2]


SELECT

	T2.SlpName			AS	'Sales Employee',
	T0.DocNum			AS	'Invoice',
	T1.BaseRef			AS	'OrderNum',+
	T0.DocDate,
	T0.CardName,
	T0.CardCode,
	T1.LineNum,
	T1.ItemCode,
	T1.Dscription,
	T1.Price,
	T1.DiscPrcnt,
	CASE
		WHEN T5.QryGroup1='Y' THEN (SELECT T01.U_Length FROM INV1 T01 WHERE T01.DocEntry=T0.DocEntry AND T01.LineNum=T1.LineNum AND T01.ItemCode=T3.ItemCode )
		WHEN T5.QryGroup1='N' THEN (SELECT T0.SLength1 FROM OITM T0 WHERE T0.ItemCode=T3.ItemCode )
	END 'Around',
	CASE
		WHEN T5.QryGroup1='Y' THEN (SELECT T01.U_Width FROM INV1 T01 WHERE T01.DocEntry=T0.DocEntry AND T01.LineNum=T1.LineNum AND T01.ItemCode=T3.ItemCode )
		WHEN T5.QryGroup1='N' THEN (SELECT T0.SWidth1 FROM OITM T0 WHERE T0.ItemCode=T3.ItemCode )
	END 'Across',
	CASE
		WHEN T5.QryGroup1='Y' THEN (SELECT ISNUMERIC(T01.U_Gauge) FROM INV1 T01 WHERE T01.DocEntry=T0.DocEntry AND T01.LineNum=T1.LineNum AND T01.ItemCode=T3.ItemCode )
		WHEN T5.QryGroup1='N' THEN (SELECT T0.SHeight1 FROM OITM T0 WHERE T0.ItemCode=T3.ItemCode )
	END 'Gauge',
    T1.u_ship_quantity             'Ship Quantity',
    T1.Quantity,
	T1.LineTotal



FROM OINV T0	WITH (NOLOCK)

	INNER JOIN INV1 T1 ON T1.DocEntry=T0.DocEntry
	INNER JOIN OSLP T2 ON T2.SlpCode=T0.SlpCode
	LEFT OUTER JOIN OITM T3 ON T3.ItemCode=T1.ItemCode
	LEFT OUTER JOIN DLN1 T4 ON T4.DocEntry=T1.BaseEntry AND T4.LineNum=T1.LineNum
	LEFT OUTER JOIN OCRD T5	ON T5.CardCode=T0.CardCode

WHERE

    T0.DocDate>=@BeginDate              AND T0.DocDate<=@EndDate                AND
    T0.CANCELED='N'						AND T0.DocType <> 'S'					AND T5.QryGroup1=@QryGroup1

UNION ALL

SELECT

	T1.SlpName,
	MAX(T0.DocNum) AS DocNum,
	'OrderNum',
	NULL,
	T0.DocDate AS 'Posting Date',
	T2.Cardname as 'Customer',
	T2.CardCode as 'Cust Code',
	NULL,
	NULL,
	NULL,
	0,
	0,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	CASE
		WHEN T0.CANCELED = 'C' THEN SUM(T0.DocTotal-T0.VatSum-T0.TotalExpns-T0.RoundDif)
		ELSE -SUM(T0.DocTotal-T0.VatSum-T0.TotalExpns-T0.RoundDif)
	END AS 'Amount'

FROM ORIN T0 WITH (NOLOCK)

	LEFT OUTER JOIN OSLP T1 ON T1.SlpCode=T0.SlpCode
	LEFT OUTER JOIN OCRD T2 ON T2.CardCode =T0.CardCode

WHERE

	T0.DocDate BETWEEN @BeginDate AND @EndDate
	AND NOT EXISTS (SELECT 1 FROM RIN1 TS1 WHERE TS1.DocEntry = T0.DocEntry AND TS1.BaseType = 203)

GROUP BY

	T0.DocDate,
	T0.DocEntry,
	T0.CANCELED,
	T1.SlpName,
	T2.Cardname,
	T2.CardCode
