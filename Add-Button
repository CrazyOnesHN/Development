Private Sub cmdAdd_Click()

    Dim ctr As Control
    Dim InpReq As Boolean
    Dim rowMaster As Long
    
    On Error GoTo errorHandle
    
'validate required fields on frmCustomer

    InpReq = True
    For Each ctr In Me.Controls
        If TypeName(ctr) = "TextBox" Then
            If ctr.Tag = "required" Then
                If ctr.Text = "" Then
                    InpReq = False
                End If
            End If 'tag
        End If 'typename
    Next ctr

    If InpReq = False Then
        MsgBox "Please input the required fields which are marked with ""*""" & vbNewLine & _
        vbCritical, "Input incomplete"
        Me.txtCustomerName.SetFocus
        Exit Sub
    End If


'add data to CustMasterData - Sheet2

    With CustMasterData
    
        If Me.cmdAdd.Caption = "Update" Then
            rowMaster = EditNum
        Else
            rowMaster = .ListObjects("CustMasterData").Range.Rows.Count + 1
        End If
        
        .Range("A" & rowMaster) = Me.txtCustomerCode
        .Range("B" & rowMaster) = Me.txtCustomerName
        .Range("C" & rowMaster) = Me.txtBillTo
        .Range("D" & rowMaster) = Me.txtShipTo
        .Range("E" & rowMaster) = Me.cboPaymentTerms.Value
        .Range("F" & rowMaster) = Me.txtPhone
        .Range("G" & rowMaster) = Me.txtFax
        .Range("H" & rowMaster) = Me.txtEmail
        .Range("I" & rowMaster) = Me.txtContactPerson
    
    
    End With
    
    Unload Me
    MsgBox "Customer data has been updated", vbInformation, "Updated!"
    Exit Sub

errorHandle:
    MsgBox "It looks like an error has occurred! Please make sure you have followed the instructions.", vbCritical
    Unload Me

End Sub


Private Sub cmdEdit_Click()

    EditNum = Me.lstCustomer.ListIndex
    If EditNum = -1 Then
        
        MsgBox "Nothing has been selected"
    
    Else
        
        EditNum = EditNum + 2
        'copy values from listbox to frmCustomer
        frmCustomer.txtCustomerCode = CustMasterData.Range("A" & EditNum)
        frmCustomer.txtCustomerName = CustMasterData.Range("B" & EditNum)
        frmCustomer.txtBillTo = CustMasterData.Range("C" & EditNum)
        frmCustomer.txtShipTo = CustMasterData.Range("D" & EditNum)
        frmCustomer.cboPaymentTerms.Value = CustMasterData.Range("E" & EditNum)
        frmCustomer.txtPhone = CustMasterData.Range("F" & EditNum)
        frmCustomer.txtFax = CustMasterData.Range("G" & EditNum)
        frmCustomer.txtEmail = CustMasterData.Range("H" & EditNum)
        frmCustomer.txtContactPerson = CustMasterData.Range("I" & EditNum)
        
        Unload Me
        frmCustomer.cmdAdd.Caption = "Update"
        frmCustomer.Show
      
      End If


End Sub

' Get 

Private Sub btInvoice_Click()

    Dim ExcelPath As String
    Dim r As Long
    Dim PosTextRow As Byte
    Dim InvTable As ListObject
    Dim NextInvoice As Variant
    Dim NewBook As Workbook
    
    On Error GoTo ErrorHandle
    
    '1. Check if Folders exist
    ExcelPath = Application.ThisWorkbook.Path & "\" & Range("Excel_Folder").Value
    PDFPath = Application.ThisWorkbook.Path & "\" & Range("PDF_Folder").Value
    
    If Dir(ExcelPath, vbDirectory) = VBA.Constants.vbNullString Or Dir(PDFPath, vbDirectory) = VBA.Constants.vbNullString Then
        MsgBox "The Excel & PDF folders do not exist. Please create these in the same folder as this workbook first.", vbInformation, "Folder does not exist"
        Exit Sub
    End If
    '2. Figure out what has been selected in the List Box
    If Me.lbOpenInvoice.ListIndex = -1 Then
        MsgBox "Please select a an invoice from the list"
        Exit Sub
    Else
        Application.ScreenUpdating = False
        Application.DisplayAlerts = False
        
        PosTextRow = InStr(1, Me.lbOpenInvoice.Value, " - Table Row: ", vbTextCompare) + Len(" - Table Row: ")
        r = CLng(Mid(Me.lbOpenInvoice.Value, PosTextRow))
        
    '3. Update Invoice Table by assigning a new Invoice number if missing
        Set InvTable = shInvoice.ListObjects("InvoiceTable")
        'check if there is at least a number in amount 1 before creating the invoice

        If InvTable.ListColumns("Amount Line 1").DataBodyRange(r).Value = "" Then
            MsgBox "There is no value to invoice yet."
            Unload Me
            Exit Sub
        End If

        NextInvoice = InvTable.ListColumns("Invoice Number").DataBodyRange(r).Value
        If NextInvoice = "" Then NextInvoice = Application.WorksheetFunction.Max(InvTable.ListColumns("Invoice Number").DataBodyRange) + 1
        InvTable.ListColumns("Invoice Number").DataBodyRange(r).Value = NextInvoice
        
    '4. Copy fields from Invoice table to template tab
        shTemp.Range("D7").Value = NextInvoice
        shTemp.Range("D8").Value = Date
        shTemp.Range("B12").Value = InvTable.ListColumns("Company").DataBodyRange(r).Value
        shTemp.Range("B13").Value = InvTable.ListColumns("Customer").DataBodyRange(r).Value
        shTemp.Range("B15").Value = InvTable.ListColumns("Address Line 1").DataBodyRange(r).Value
        shTemp.Range("B16").Value = InvTable.ListColumns("Address Line 2").DataBodyRange(r).Value
        shTemp.Range("B17").Value = InvTable.ListColumns("Address Line 3").DataBodyRange(r).Value
        shTemp.Range("B21").Value = InvTable.ListColumns("Services Line 1").DataBodyRange(r).Value
        shTemp.Range("C21").Value = InvTable.ListColumns("Date Line 1").DataBodyRange(r).Value
        shTemp.Range("D21").Value = InvTable.ListColumns("Amount Line 1").DataBodyRange(r).Value
        shTemp.Range("B22").Value = InvTable.ListColumns("Services Line 2").DataBodyRange(r).Value
        shTemp.Range("C22").Value = InvTable.ListColumns("Date Line 2").DataBodyRange(r).Value
        shTemp.Range("D22").Value = InvTable.ListColumns("Amount Line 2").DataBodyRange(r).Value
        shTemp.Range("B23").Value = InvTable.ListColumns("Services Line 3").DataBodyRange(r).Value
        shTemp.Range("C23").Value = InvTable.ListColumns("Date Line 3").DataBodyRange(r).Value
        shTemp.Range("D23").Value = InvTable.ListColumns("Amount Line 3").DataBodyRange(r).Value
        'VAT
        shTemp.Range("E21").Value = InvTable.ListColumns("VAT").DataBodyRange(r).Value


        'make sure service text is fully visible
         shTemp.Rows("21:23").EntireRow.AutoFit
    
    '5. Create a new Excel Workbook for the invoice selected
        Set NewBook = Workbooks.Add
        shTemp.Copy before:=NewBook.Sheets(1)
        NewBook.ActiveSheet.Name = CStr(NextInvoice)
        
    '6. Create a PDF Version of the Invoice
        FileName = "\" & NextInvoice & "_" & shTemp.Range("B12").Value
        NewBook.ActiveSheet.ExportAsFixedFormat Type:=xlTypePDF, FileName:=PDFPath & FileName
        NewBook.SaveAs FileName:=ExcelPath & FileName
        NewBook.Close
        
    '7. Add Date and update status to "created" in Invoice Table
        InvTable.ListColumns("Invoice Date").DataBodyRange(r).Value = Date
        InvTable.ListColumns("Status").DataBodyRange(r).Value = "Created"
    
        Application.ScreenUpdating = True
        Application.DisplayAlerts = True
        MsgBox "Invoice for " & Me.lbOpenInvoice.Value & " has been created!" & vbNewLine _
        & vbNewLine & "Excel file is saved here: " & ExcelPath & FileName & vbNewLine _
        & vbNewLine & "PDF file is saved here: " & PDFPath & FileName, vbInformation, "Invoice Created!"

    '8. Move on to the second page of Multipage control
        Me.MPInvoice.Value = 1
    End If
        Exit Sub
ErrorHandle:
    MsgBox "It looks like an error has occurred! Please make sure you have followed the instructions.", vbCritical
    Unload Me
End Sub
